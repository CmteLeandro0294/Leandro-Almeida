<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cotação de Voo Executivo v2</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <style>
    :root {
      --primary: #0d6efd;
      --primary-hover: #0b5ed7;
      --bg: #f8f9fa;
      --surface: #fff;
      --text: #212529;
      --border: #ced4da;
    }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; margin:0; background:var(--bg); color:var(--text); }
    main { max-width:900px; margin:0 auto; padding:1.5rem; }
    h1 { text-align:center; margin-bottom:1.5rem; }
    label { font-weight:600; display:block; margin-top:1rem; }
    input, select, textarea { width:100%; padding:.5rem; margin-top:.3rem; border:1px solid var(--border); border-radius:4px; }
    input:focus, select:focus, textarea:focus { outline:2px solid var(--primary); outline-offset:2px; }
    .linha { display:flex; flex-wrap:wrap; gap:1rem; }
    .linha > div { flex:1 1 200px; }
    .botoes { margin-top:2rem; display:flex; flex-wrap:wrap; gap:.5rem; }
    button { background:var(--primary); color:#fff; border:none; padding:.75rem 1rem; font-size:1rem; border-radius:4px; cursor:pointer; }
    button:hover { background:var(--primary-hover); }
    #resultado { margin-top:2rem; padding:1rem; background:var(--surface); border:1px solid var(--border); border-radius:6px; }
    #tarifaPreview { font-size:.9rem; font-weight:500; margin-top:.2rem; }
  </style>
</head>
<body>
  <main>
    <h1>Cotação de Voo Executivo</h1>

    <label for="aeronave">Aeronave:</label>
    <select id="aeronave">
      <option value="" disabled selected>Escolha uma aeronave</option>
      <option value="Hawker 400">Hawker 400 — R$36,00/km</option>
      <option value="Phenom 100">Phenom 100 — R$36,00/km</option>
      <option value="Citation II">Citation II — R$36,00/km</option>
      <option value="King Air C90">King Air C90 — R$30,00/km</option>
      <option value="Sêneca IV">Sêneca IV — R$22,00/km</option>
      <option value="Cirrus SR22">Cirrus SR22 — R$15,00/km</option>
    </select>

    <label for="tarifa">Tarifa por km (R$):</label>
    <input type="number" id="tarifa" step="0.01" />
    <div id="tarifaPreview"></div>

    <div class="linha">
      <div>
        <label for="nm">Distância (NM):</label>
        <input type="number" id="nm" />
      </div>
      <div>
        <label for="km">Distância (KM):</label>
        <input type="number" id="km" />
      </div>
    </div>

    <div class="linha">
      <div>
        <label for="origem">Origem (ICAO):</label>
        <input type="text" id="origem" maxlength="4" class="icao" />
      </div>
      <div>
        <label for="destino">Destino (ICAO):</label>
        <input type="text" id="destino" maxlength="4" class="icao" />
      </div>
    </div>

    <label for="valorExtra">Acréscimo ou Desconto:</label>
    <input type="number" id="valorExtra" placeholder="Valor em R$" />
    <select id="tipoExtra">
      <option value="soma">Adicionar</option>
      <option value="subtrai">Subtrair</option>
    </select>

    <section id="commission-component" style="margin-top:1rem">
      <button type="button" id="btnAddCommission" aria-pressed="false">Adicionar comissão</button>
      <div id="commissionPanel" hidden>
        <label for="commissionPercent">Percentual da comissão (%)</label>
        <input id="commissionPercent" type="number" min="0" max="100" step="0.1" value="5" />
        <output id="commissionPreview">Comissão: R$ 0,00</output>
      </div>
      <input type="hidden" id="commissionAmount" value="0" />
    </section>

    <div class="botoes">
      <button type="button" id="btnPre">Gerar Pré-Orçamento</button>
      <button type="button" id="btnPdf">Gerar PDF</button>
    </div>

    <div id="resultado"></div>
  </main>

  <script>
    const valoresKm = {
      'Hawker 400': 36,
      'Phenom 100': 36,
      'Citation II': 36,
      'King Air C90': 30,
      'Sêneca IV': 22,
      'Cirrus SR22': 15
    };

    const selAeronave = document.getElementById('aeronave');
    const tarifaInput = document.getElementById('tarifa');
    const tarifaPreview = document.getElementById('tarifaPreview');
    selAeronave.addEventListener('change', () => {
      const valor = valoresKm[selAeronave.value] || 0;
      tarifaInput.value = valor.toFixed(2);
      tarifaPreview.textContent = valor ? `Tarifa selecionada: R$ ${valor.toFixed(2)}/km` : '';
    });

    // Conversão NM <-> KM
    const nmInput = document.getElementById('nm');
    const kmInput = document.getElementById('km');
    nmInput.addEventListener('input', () => {
      const nm = parseFloat(nmInput.value);
      kmInput.value = nm ? (nm * 1.852).toFixed(2) : '';
    });
    kmInput.addEventListener('input', () => {
      const km = parseFloat(kmInput.value);
      nmInput.value = km ? (km / 1.852).toFixed(2) : '';
    });

    // Comissão
    const btnAdd = document.getElementById('btnAddCommission');
    const panel = document.getElementById('commissionPanel');
    const percentInput = document.getElementById('commissionPercent');
    const preview = document.getElementById('commissionPreview');
    const amountHidden = document.getElementById('commissionAmount');
    const fmtBRL = n => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n);

    btnAdd.addEventListener('click', () => {
      const enabled = panel.hasAttribute('hidden') ? false : true;
      if (enabled) {
        panel.hidden = true;
        btnAdd.textContent = 'Adicionar comissão';
        btnAdd.setAttribute('aria-pressed','false');
        amountHidden.value = '0';
        preview.textContent = 'Comissão: R$ 0,00';
      } else {
        panel.hidden = false;
        btnAdd.textContent = 'Remover comissão';
        btnAdd.setAttribute('aria-pressed','true');
      }
    });

    function calcularComissao(base){
      if (panel.hidden) return 0;
      const percent = Number(percentInput.value)||0;
      const valor = base * (percent/100);
      amountHidden.value = valor.toFixed(2);
      preview.textContent = `Comissão: ${fmtBRL(valor)}`;
      return valor;
    }

    function gerarPreOrcamento(){
      const aeronave = selAeronave.value;
      const km = parseFloat(kmInput.value) || 0;
      const tarifa = parseFloat(tarifaInput.value) || 0;
      const origem = document.getElementById('origem').value.toUpperCase();
      const destino = document.getElementById('destino').value.toUpperCase();
      const valorExtra = parseFloat(document.getElementById('valorExtra').value) || 0;
      const tipoExtra = document.getElementById('tipoExtra').value;

      let total = km * tarifa;
      const comissao = calcularComissao(total);
      total += comissao;

      let labelExtra = '';
      if (valorExtra>0) {
        total = tipoExtra==='soma'? total+valorExtra : total-valorExtra;
        labelExtra = tipoExtra==='soma'
          ? `+ ${fmtBRL(valorExtra)} (outras despesas)`
          : `- ${fmtBRL(valorExtra)} (desconto)`;
      }

      const html = `<h3>Pré-Orçamento</h3>
        <p><strong>Origem:</strong> ${origem}</p>
        <p><strong>Destino:</strong> ${destino}</p>
        <p><strong>Aeronave:</strong> ${aeronave}</p>
        <p><strong>Distância:</strong> ${nmInput.value || 0} NM (${km.toFixed(2)} km)</p>
        ${labelExtra ? `<p><strong>Ajuste:</strong> ${labelExtra}</p>` : ''}
        ${comissao? `<p><strong>Comissão:</strong> ${fmtBRL(comissao)}</p>` : ''}
        <p><strong>Total Estimado:</strong> ${fmtBRL(total)}</p>`;
      document.getElementById('resultado').innerHTML = html;
      return {aeronave,km,origem,destino,total,labelExtra};
    }

    function gerarPDF(){
      const dados = gerarPreOrcamento();
      const docDefinition = {
        content:[
          {text:'Cotação de Voo Executivo', style:'header'},
          {text:`Origem: ${dados.origem} → Destino: ${dados.destino}`, margin:[0,10,0,0]},
          {text:`Aeronave: ${dados.aeronave}`},
          {text:`Distância: ${nmInput.value||0} NM (${parseFloat(kmInput.value||0).toFixed(2)} km)`},
          dados.labelExtra ? {text:`Ajuste: ${dados.labelExtra}`} : null,
          {text:`Total Estimado: ${fmtBRL(dados.total)}`, bold:true, margin:[0,10,0,0]}
        ],
        styles:{ header:{fontSize:18,bold:true} }
      };
      pdfMake.createPdf(docDefinition).open();
    }

    document.getElementById('btnPre').addEventListener('click', gerarPreOrcamento);
    document.getElementById('btnPdf').addEventListener('click', gerarPDF);
  </script>
</body>
</html>
